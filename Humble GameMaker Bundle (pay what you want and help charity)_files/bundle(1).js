define("pubsub",["backbone","underscore"],function(e,t){"use strict";var s=function(){t.extend(this,e.Events),this._store={},this.subscribe=function(e,s){t.has(this._store,e)&&s.apply(null,this._store[e]),this.on(e,s)},this.publish=function(e){var t=Array.prototype.slice.call(arguments,1);this._store[e]=t,this.trigger.apply(this,arguments)},t.bindAll(this,"subscribe","publish")};return s}),define("charity/helpers",["pubsub"],function(e){return{BODY_SEARCH_PAGE_SIZE:14,ORDER_FORM_SEARCH_PAGE_SIZE:6,charityPubSub:new e,updateUserCharity:function(e,t,s,i){t[e.CSRF_FORM_KEY]=e.CSRF_TOKEN,$.ajax({type:"POST",url:"/api/v1/user/charity",data:t,error:i,success:s})}}}),define("charity/models",["backbone"],function(e){var t=e.Model.extend({idAttribute:"charity_id",defaults:{human_name:"",logo_url:"",charity_id:""}}),s=e.Collection.extend({model:t,comparator:function(e){return e.get("human_name")}});return{Charity:t,CharityList:s}}),define("lib/hbTemplate!charity/templates/selectionError.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"  <div class='charity-selection-message'>\n    <h1>Loading failed</h1>\n    <p>You may have a connection problem, or our server may be experiencing issues.</p>\n  </div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/selectionLoading.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"  <div class='charity-selection-message'>\n    <img src='xSTATIC_URLx/static/hashed/26faf55c6e36ba3b1a57f9001942059fe05050f2.gif' alt='' />\n    <h1>Loadingâ€¦</h1>\n  </div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/selectionNoResults.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"  <div class='charity-selection-message'>\n    <h1>No results.</h1>\n  </div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("charity/baseViews",["backbone","charity/helpers","hbtemplate!./templates/selectionError.html","hbtemplate!./templates/selectionLoading.html","hbtemplate!./templates/selectionNoResults.html"],function(e,t,s,i,a){"use strict";var n=_.template(s),r=_.template(i),l=_.template(a),c=e.View.extend({tagName:"div",className:"charity-preview",initialize:function(e){this.options=e,_.bindAll(this,"render","select_this_charity","update_charity"),this.constants=this.options.constants,this.is_disallowed=e.is_disallowed,this.pubSub=t.charityPubSub,this.pubSub.subscribe("charity_updated",this.update_charity),this.rendered=!1},render:function(){this.rendered=!0,this.$(".js-select-charity").on("click",this.select_this_charity),this.is_disallowed&&this.$el.addClass("is-disallowed")},get_template_params:function(){var e=this.model.toJSON();return e.is_selected=this.is_selected,e.country=this.constants.CHARITY_SEARCH_PARAMS.country[this.model.get("country")],e.is_disallowed=this.is_disallowed,e.current_url=window.location.origin+window.location.pathname,e},select_this_charity:function(e){e.preventDefault(),e.stopPropagation(),this.is_disallowed||this.model&&this.pubSub.publish("set_charity",{current_charity_is_random:!1,current_charity:this.model})},update_charity:function(e){e.current_charity&&(this.is_selected=this.model.get("charity_id")==e.current_charity.get("charity_id"),this.rendered&&(this.is_selected?this.$(".js-select-charity").addClass("is-selected"):this.$(".js-select-charity").removeClass("is-selected"),this.is_disallowed?this.$(".js-select-charity").addClass("is-disallowed"):this.$(".js-select-charity").removeClass("is-disallowed")))}}),h=e.View.extend({tagName:"div",className:"charity-list",events:{},initialize:function(e){this.options=e,_.bindAll(this,"render","renderCharityPreview"),this.constants=this.options.constants,this.pubSub=this.options.pubSub},render:function(){var e=this;return this.$el.empty(),this.collection.each(function(t){e.$el.append(e.renderCharityPreview(t))}),this.delegateEvents(),this.el}}),o=e.View.extend({initialize:function(e){this.pubSub=e.pubSub,this.last_sent_request_id=0,this.last_received_request_id=-1,this.UNITED_STATES="US",this.num_results=0,this.page=1,this.PAGE_SIZE=void 0,_(this).bindAll("handleServerResponse","handleCountryChange","showNoResultsState","showLoadingState","showErrorState")},handleServerResponse:function(e){var t=Math.min(1e3,e.num_results);return this.num_results=t,this.num_pages=Math.ceil(t/this.constants.CHARITY_RESULTS_PAGE_SIZE),0==e.results.length?void this.showNoResultsState():(1==e.num_results?this.$(".js-results-heading").text(e.num_results+" result for search"):e.num_results>1e3?(this.$(".js-results-heading").text("1000+ results"),this.$(".js-results-heading-disclaimer").show()):this.$(".js-results-heading").text(e.num_results+" results for search"),this.collection.add(e.results),this.search_results_collection.reset(e.results),void this.renderSearchResults())},handleCountryChange:function(){var e=this.$(".js-country-label"),t=this.$(".js-state-label"),s=this.$(".js-charity-country");s.val()==this.UNITED_STATES?(t.addClass("is-united-states"),e.addClass("is-united-states")):(t.removeClass("is-united-states"),e.removeClass("is-united-states"))},showLoadingState:function(){this.$(".js-results-heading").text(""),this.$(".js-results-heading-disclaimer").hide();var e=this.$(".js-charity-results");e.html(r({}))},showErrorState:function(){this.$(".js-results-heading").text("");var e=this.$(".js-charity-results");e.html(n({}))},showNoResultsState:function(){this.$(".js-results-heading").text("0 results for search");var e=this.$(".js-charity-results");e.html(l({}))},searchCharities:function(e,t,s,i,a,n){var r=this,l=5,c=function(l){r.showLoadingState(),$.ajax({type:"GET",url:"/api/v1/charity/search",data:{query:e,category:t,country:s,state:i,page:a-1,page_size:n,request:++r.last_sent_request_id},error:function(){0===l?r.showErrorState():c(l-1)},success:function(e){var t=parseInt(e.request);t>r.last_received_request_id?(r.last_received_request_id=t,r.handleServerResponse(e)):console.log("ignoring")}})};c(l)}});return{BaseCharityPreviewView:c,BaseCharityListView:h,BaseSelectionView:o}}),define("lib/hbTemplate!charity/templates/bundleCTA.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return'<% if (typeof logo_url !== "undefined") { %>\n  <div class=\'charity-img\' style=\'background-image: url("<%= logo_url %>"); background-color: white;\'></div>\n<% } else { %>\n  <div class=\'charity-img\' style=\'background-image: url(xSTATIC_URLx/static/hashed/dc1731765c200d9ba424bd3b173207f382a55ef4.png)\' alt=""></div>\n<% } %>\n\n  <div class="text">\n<% if (typeof heading !== "undefined") { %>\n    <h3><%= heading %></h3>\n    <p>If you would like to support a different charity,<br> <span class="js-show-chooser show-chooser">select a new one</span> from a database of thousands.</p>\n<% } else { %>\n    <h3>Choose Your Own Charity!</h3>\n    <p>In addition to the charities above, you can designate funds <br>to a charity of your choice! <span class="js-show-chooser show-chooser">Select one</span> from a list of thousands.</p>\n<% }  %>\n  </div>\n'.replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/slideOutHolder.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return'<div class="constrain-width">\n  <div class="cyoc-cta js-cyoc-cta">\n\n  </div>\n</div>\n<div class="slideout-expandable js-cyoc-selector-slide cyoc-selector-slide">\n  <div class="constrain-width">\n    <div class="selected-game-arrow top-arrow"></div>\n    <div class="js-cyoc-select-holder charity-selection"></div>\n  </div>\n</div>\n<div class="js-charity-details-popup-holder charity-details-popup-holder"></div>\n'.replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/selectionView.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"    <h2>Charity Search</h2>\n    <div class=\"js-featured-charities-holder\"></div>\n    <div class='charity-search js-charity-search'>\n      <label class='query'>\n        <input type='text' name='search' class='js-charity-query' placeholder='Search names or keywords'>\n        <i class='hb hb-search'></i>\n      </label><label class='category'>Category\n        <select name='category' class='js-charity-category'>\n          <option value='' selected>All</option>\n<% _.each(categories, function(val, key) { %>\n          <option value='<%- key %>'><%- val %></option>\n<% }); %>\n        </select>\n      </label><label class='country js-country-label'>Country\n        <select name='country' class='js-charity-country'>\n          <option value='' selected>All</option>\n<% _.each(countries, function(val, key) { %>\n          <option value='<%- key %>'><%- val %></option>\n<% }); %>\n        </select>\n      </label><label class='state js-state-label'>State\n        <select name='state' class='js-charity-state'>\n          <option value='' selected>All</option>\n<% _.each(_.sortBy(_.pairs(states), function(tuple) { return tuple[1]; }), function(tuple) { %>\n          <option value='<%- tuple[0] %>'><%- tuple[1] %></option>\n<% }); %>\n        </select>\n      </label><button class='js-submit-search' type='submit'>Search</button>\n    </div>\n    <h3 class='js-results-heading results-heading'>Suggested charities</h3>\n    <h4 class='js-results-heading-disclaimer results-heading-disclaimer'>Note: only 1000 results are displayed per search</h4>\n    <div class='js-charity-results charity-results'></div>\n    <div class=\"partnership-line\">In partnership with <a href=\"https://www.paypal.com/givingfund/\" target=\"_blank\">PayPal Giving Fund</a></div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/charityPreview.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"  <div class='js-see-details charity-img' style='background-image: url(\"<%= logo_url %>\");'></div>\n  <div class='charity-name'>\n    <a class='js-see-details see-details' data-charity-id=\"<%= charity_id %>\">\n      <h4 title='<%= human_name %>'><%= human_name %></h4>\n      <h5 class='location'><% if (country == 'United States') {  %><%- city %>, <%- state %><% } else { %><%- country %><% } %></h5>\n    </a>\n    <button class='\n      select-charity\n      js-select-charity\n  <% if (is_selected) { %>\n      is-selected\n  <% } %>\n  <% if (is_disallowed) { %>\n      is-disallowed\n  <% } %>\n    '>\n      <span class='selected-text'>Selected</span>\n      <span class='unselected-text'>Select</span>\n      <span class='disallowed-text'>Default</span>\n    </button>\n  </div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/charityPopUp.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"<div class=\"charity-popup\">\n  <div class=\"close-button-holder\">\n    <img class=\"js-close close-button\" src=\"xSTATIC_URLx/static/hashed/c0ff4994a7eb5d28cbb610f9dd515b08e3fdb8d1.png\" alt=\"\">\n  </div>\n  <div class=\"flex-wrapper\">\n    <div class='charity-img' style='background-image: url(\"<%= logo_url %>\");'></div>\n    <div class=\"right-pane\">\n      <div class='charity-title'>\n        <h2><%= human_name %></h2>\n      </div>\n      <div class='charity-sidebar'>\n        <p class='charity-info'><strong>Category:</strong> <i><%= category %></i></p>\n        <p class='charity-info'><strong>Location:</strong>\n          <i>\n  <% if (country == 'United States') { %>\n          <%- city %>, <%- state %>\n  <% } else { %>\n          <%- country %>\n  <% } %>\n          </i>\n        </p>\n  <% if (url) { %>\n        <a class='charity-link' href='<%= url %>'>Visit their website</a>\n  <% } %>\n        <div class='charity-description'>\n          <%= description %>\n        </div>\n\n        <p class='charity-info'>\n          <strong>Recommend this charity</strong><br>\n          Use this link to refer a friend to this bundle in support of <%= human_name %>:<br>\n          <a href=\"<%= current_url %>?charity=<%= charity_id %>\"><%= current_url %>?charity=<%= charity_id %></a>\n        </p>\n      </div>\n    </div>\n  </div>\n</div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("lib/hbTemplate!charity/templates/selectionLoadingBundle.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return"  <div class='charity-selection-message'>\n    <img class=\"cyoc-spinner-light\" src='xSTATIC_URLx/static/hashed/26faf55c6e36ba3b1a57f9001942059fe05050f2.gif' alt='' />\n    <img class=\"cyoc-spinner-dark\" src='xSTATIC_URLx/static/hashed/d75f6277a2eb64ec4986978ea3955e9d2434e389.gif' alt='' />\n    <h1>Loadingâ€¦</h1>\n  </div>\n".replace(/xSTATIC_URLx/g,t)}()}),define("charity/templates/bundle",["underscore","hbtemplate!./bundleCTA.html","hbtemplate!./slideOutHolder.html","hbtemplate!./selectionView.html","hbtemplate!./charityPreview.html","hbtemplate!./charityPopUp.html","hbtemplate!./selectionError.html","hbtemplate!./selectionLoadingBundle.html","hbtemplate!./selectionNoResults.html"],function(e,t,s,i,a,n,r,l,c){return{bundleCTA:e.template(t),slideOutHolder:e.template(s),selectionView:e.template(i),charityPreview:e.template(a),charityPopUp:e.template(n),selectionError:e.template(r),selectionLoading:e.template(l),selectionNoResults:e.template(c)}}),define("lib/hbTemplate!pagination/templates/paginationControls.html",function(){return function(){var e="www.humblebundle.com"===window.location.hostname,t=e?"https://humblebundle-a.akamaihd.net":"";return'<% if (totalPages > 1) { %>\n<div class="pagination">\n  <% var lastRendered = 0 %>\n  <% if (currentPage !== 0) { %>\n  <div class="js-jump-to-page jump-to-page" data-index="<%= currentPage - 1 %>"><i class="hb hb-chevron-left"></i></div>\n  <% } %>\n  <% for (var i = 0; i < totalPages; i++) { %>\n    <% var shouldShow = indicesToShow.indexOf(i) !== -1 %>\n    <% if (shouldShow) { %>\n      <% if (i - lastRendered > 1) { %>\n    ...\n      <% } %>\n      <% lastRendered = i %>\n  <div class="js-jump-to-page jump-to-page<% if (i === currentPage) { %> current<% } %>" data-index="<%= i %>"><%= i + 1 %></div>\n    <% } %>\n  <% } %>\n  <% if (currentPage !== totalPages - 1) { %>\n  <div class="js-jump-to-page jump-to-page" data-index="<%= currentPage + 1 %>"><i class="hb hb-chevron-right"></i></div>\n  <% } %>\n</div>\n<% } %>\n'.replace(/xSTATIC_URLx/g,t)}()}),define("pagination/pagination",["underscore","jquery","hbtemplate!./templates/paginationControls.html"],function(e,t,s){"use strict";function i(e,t,s){s=s||r;var i=s*t;return{controls:a(e.length,t,s),pageItems:e.slice(i,i+s)}}function a(e,t,s){s=s||r;var i=Math.ceil(e/s),a=[0,1,i-1,i-2,t-1,t,t+1];return l({totalPages:i,currentPage:t,indicesToShow:a})}function n(e){return parseInt(t(e.target).closest(".js-jump-to-page").data("index"))}var r=20,l=e.template(s);return{paginate:i,parseClick:n,renderControls:a}}),define("charity/bundle",["backbone","underscore","charity/helpers","charity/models","charity/baseViews","./templates/bundle","pagination/pagination"],function(e,t,s,i,a,n,r){"use strict";var l=s.charityPubSub,c=a.BaseCharityPreviewView.extend({tagName:"div",className:"charity-preview",events:{"click .js-see-details":"see_details"},initialize:function(e){a.BaseCharityPreviewView.prototype.initialize.call(this,e),t(this).bindAll("see_details")},render:function(){return this.$el.html(n.charityPreview(this.get_template_params())),a.BaseCharityPreviewView.prototype.render.call(this),this.el},see_details:function(e){e.preventDefault(),new h({el:$(".grayout-inner"),constants:this.constants,model:this.model})}}),h=c.extend({initialize:function(e){c.prototype.initialize.call(this,e),this.render()},events:t.extend(c.prototype.events,{click:"stop_propagation","click .js-close":"close"}),render:function(){var e=$(".grayout");e.show(),e.on("click",this.close),this.$el.html(n.charityPopUp(this.get_template_params())),this.$el.show(),a.BaseCharityPreviewView.prototype.render.call(this)},close:function(){var e=$(".grayout");e.hide(),e.off("click"),view.$el.hide()},stop_propagation:function(e){e.stopPropagation()}}),o=a.BaseCharityListView.extend({renderCharityPreview:function(e){var s=t.contains(this.constants.disallowed_charity_ids,e.get("charity_id")),i=new c({model:e,constants:this.constants,pubSub:this.pubSub,is_disallowed:s});return i.render()}}),d=a.BaseSelectionView.extend({tagName:"div",events:{"click .js-submit-search":"submitSearch","keyup .js-charity-query":"submitSearch","change .js-charity-country":"handleCountryChange","click .js-jump-to-page":"jumpToPage"},initialize:function(e){a.BaseSelectionView.prototype.initialize.call(this,e),t(this).bindAll("submitSearch","jumpToPage"),this.pubSub=e.pubSub,this.constants=getCharityVars(),this.collection=this.search_results_collection=new i.CharityList(this.constants.featured_charities),this.PAGE_SIZE=e.page_size,this.UNITED_STATES="US",this.charitySearchResultsView=new o({disallowed_charity_ids:this.constants.disallowed_charity_ids,collection:this.search_results_collection,constants:this.constants,pubSub:this.pubSub}),this.render(),this.$(".js-charity-results").append(this.charitySearchResultsView.render())},jumpToPage:function(e){e.preventDefault();var t=r.parseClick(e);this.page=t+1,this.submitSearch(e)},render:function(){var e={categories:this.constants.CHARITY_SEARCH_PARAMS.category,countries:this.constants.CHARITY_SEARCH_PARAMS.country,states:this.constants.CHARITY_SEARCH_PARAMS.state};this.$el.html(n.selectionView(e))},showLoadingState:function(){this.$(".js-results-heading").text(""),this.$(".js-results-heading-disclaimer").hide();var e=this.$(".js-charity-results");e.html(n.selectionLoading({}))},submitSearch:function(e){if(!e.keyCode||13==e.keyCode){e.preventDefault();var t=this.$(".js-charity-query").val(),s=this.$(".js-charity-category").val(),i=this.$(".js-charity-country").val(),a="";i==this.UNITED_STATES&&(a=this.$(".js-charity-state").val()),this.searchCharities(t,s,i,a,this.page,this.PAGE_SIZE)}},showNoResultsState:function(){this.$(".js-results-heading").text("No results found"),this.$(".js-charity-results").empty()},renderSearchResults:function(){this.$(".pagination").remove();var e=this.$(".js-charity-results");e.empty(),e.append(this.charitySearchResultsView.render()),e.append(r.renderControls(this.num_results,this.page-1,this.PAGE_SIZE))}}),u=e.View.extend({events:{"click .js-cyoc-cta":"onClick"},initialize:function(e){t(this).bindAll("onClick","update_charity"),this.user_charity_id=e.user_charity_id,this.loggedIn=Boolean(e.email),this.constants=getCharityVars(),this.charities=new i.CharityList(this.constants.featured_charities),this.render(),l.subscribe("set_charity",this.update_charity),this.user_charity_id&&(t.contains(this.constants.disallowed_charity_ids,this.user_charity_id)||l.publish("set_charity",{current_charity:this.charities.get(this.user_charity_id)}))},update_charity:function(e){if(e.current_charity){l.publish("charity_updated",e),this.$(".js-cyoc-selector-slide").slideUp(),this.model=e.current_charity;var t=this.model.get("charity_id");this.loggedIn&&this.user_charity_id!==t&&("function"==typeof show_flash&&show_flash("Updated your preferred charity"),s.updateUserCharity(this.constants,{charity_id:t,is_bundle:!0})),this.$(".js-cyoc-cta").html(n.bundleCTA({heading:this.model.get("human_name"),logo_url:this.model.get("logo_url")}))}},onClick:function(e){this.$(".js-cyoc-selector-slide").slideToggle()},render:function(){this.$el.html(n.slideOutHolder()),this.model?this.$(".js-cyoc-cta").html(n.bundleCTA({heading:this.model.get("human_name"),logo_url:this.model.get("logo_url")})):this.$(".js-cyoc-cta").html(n.bundleCTA({})),new d({el:this.$(".js-cyoc-select-holder")[0],pubSub:l,page_size:s.BODY_SEARCH_PAGE_SIZE})}});return{CharityCTAView:u,CharitySelectionView:d}});
//# sourceMappingURL=bundle.js.map